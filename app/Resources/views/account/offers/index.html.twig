{% extends 'admin.html.twig' %}
{% block stylesheets %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-switch/3.3.2/css/bootstrap3/bootstrap-switch.min.css" />
<style>
.bootstrap-switch.bootstrap-switch-off .bootstrap-switch-label{background-color:#5cb85c;}
.bootstrap-switch.bootstrap-switch-on .bootstrap-switch-label,
.bootstrap-switch .bootstrap-switch-handle-off.bootstrap-switch-default{background-color:#757575;color:white;}
table th.times-heading,
table tr>td{max-width:260px!important;}
</style>
{% endblock %}

{% block body %}

<div class="panel panel-default">
  <div class="panel-heading">
    Offers
    <a href="#add-offer-modal" data-toggle="modal" class="admin-btn"><i class="fa fa-plus fa-lg"></i> <strong>Add Offer</strong></a>
    <a id="deleteSelectedOffersButton" class="admin-btn"><i class="fa fa-trash fa-lg"></i> <strong>Delete Offer(s)</strong></a>
  </div>
  <div class="panel-body">
    {% if offers | length > 0 %}
    <table class="table businesses-table">
      <thead>
        <tr>
          <th>ID</th>
          <!--<th><a href="#" id="check-all-box">All</a></th>-->
          <th><input name="Offers[]" class="offer-check" type="checkbox" value="all" /></th>
          <th>Category</th>
          <th>Treatment</th>
          <th>Start Date</th>
          <th class="times-heading">Times</th>
          <th>Discount</th>
          <th>Re-occurring</th>
          <th>Enabled</th>
        </tr>
      </thead>
      <tbody>
        {% for offer in offers %}
        {% set av = offer.getAvailabilitySet %}
        <tr>
          <td><span class="offer-id">
          {{ offer.getId }}
          </span></td>
          <td><span class="btns">
            <div class="btn-group"><input name="Offers[]" class="offer-check" type="checkbox" value="{{offer.getId}}"></div>
          </span></td>
          <td><span class="treatment-name">{{offer.getTreatment.getTreatmentCategory.getCategoryName}}</span></td>
          <td><span class="treatment-name">{{offer.getTreatment.getLabel}}</span></td>
          <td><span class="offer-start">{{av.getStartDate | date('d-m-Y')}}</span></td>
          <td><span class="offer-times">
            {{av.getTimes() | join(', ')}}
          </span></td>
          <td><span class="discount">
            {{ offer.getDiscountPercentage }}% /
            <span class="strikethrough">${{ offer.getTreatment.getOriginalPrice }}</span>
            ${{ offer.getCurrentPrice }}
          </span></td>
          <td><span class="recurring">
            {% if av.getRecurrenceType == 'never' %}
              <input type="checkbox" disabled="disabled">
            {% else %}
              <input type="checkbox" disabled="disabled" checked="checked"> {{ av.getRecurrenceType}}
            {% endif %}
          </span></td>
          <td><span class="enabled">
            <div class="onoffswitch">
              <form id="offerStatus{{offer.getId}}" action="{{path('admin_treatment_toggle_is_open',{'id':app.request.get('id'),'slug':app.request.get('slug')})}}" method="post">
                <input type="checkbox" name="onoffswitch" class="onoffswitch-checkbox" {% if offer.getIsOpen %}checked{% endif %}>
                <input type="hidden" name="offerId" value="{{offer.getId}}" />
              </form>
            </div>

          </span></td>
        </tr>
        {% endfor %}
      </tbody>

    </table>
    {% else %}
      <p>You have no offers</p>
    {% endif %}

  </div>
</div>

<div class="modal fade" id="add-offer-modal" tabindex="-1" role="dialog" aria-labelledby="add-availability-label">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
    {#{ form_start(form) }#}
      <form action="{{ path('admin_offer_new_path',{ slug: business.getSlug, id: business.getId }) }}" method="post">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
          <h4 class="modal-title" id="add-service-category-label">Add an Offer</h4>
        </div>
        <div class="modal-body">
          {% include "account/availability/form.html.twig" %}
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
          <button type="submit"
               class="btn btn-primary">
               <strong>Add Offer</strong> <i class="fa fa-plus fa-lg"></i>
           </button>
        </div>
      </form> <!-- /.form -->
    </div>
  </div>
</div>


{% endblock %}
{% block javascripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-switch/3.3.2/js/bootstrap-switch.min.js"></script>
<script>
jQuery(document).ready(function(){
  jQuery('.onoffswitch > form input[type="checkbox"]').bootstrapSwitch({
    onText:'&dash;',
    offText:'&times;',
    onColor:'success',
    offColor:'default',
    handleWidth:'4px',
    lableWidth:'4px',
    size:'large'
  });
});


jQuery('.onoffswitch > form input[type="checkbox"]').on('switchChange.bootstrapSwitch',function(){
  jQuery(this).parents('form').submit();
})

jQuery('a#deleteSelectedOffersButton').on('click',function(e){
  e.preventDefault();
  var $offers = jQuery(".table.businesses-table .btn-group > input:checkbox:checked");
  if($offers.length <= 0) return false;
  var offers = $offers.map(function(){
      return $(this).val();
    }).get();
    $.post( "{{ path('admin_delete_offer',{'id':app.request.get('id'),'slug':app.request.get('slug')} ) }}", { offers: offers }, function( data ) {
      console.log(data);
      $offers.each(function(i,el){
        console.log(jQuery(el));
        jQuery(el).remove();//.remove();
      });
    }, "json")
    .done(function(){
      $offers.each(function(i,el){
        jQuery(el).remove();//.remove();
      });
    });
    location.reload();
});
</script>
{% endblock %}
